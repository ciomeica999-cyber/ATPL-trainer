<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ATPL Deep Learning v17</title>
    <style>
        /* --- THEME --- */
        :root {
            --primary: #007aff;
            --orange: #ff9f0a;
            --purple: #af52de;
            --bg: #f2f2f7;
            --card: #ffffff;
            --text: #000000;
            --subtext: #6c6c70;
            --border: #c6c6c8;
            --success: #34c759;
            --error: #ff3b30;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #0a84ff;
                --orange: #ff9f0a;
                --purple: #bf5af2;
                --bg: #000000;
                --card: #1c1c1e;
                --text: #ffffff;
                --subtext: #aeaeb2;
                --border: #38383a;
                --shadow: 0 4px 20px rgba(0,0,0,0.4);
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }

        body {
            margin: 0; padding: 0; background-color: var(--bg); color: var(--text);
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* HEADER */
        header {
            height: 50px; background: var(--card); border-bottom: 0.5px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            font-weight: 700; font-size: 17px; z-index: 10;
            padding-top: env(safe-area-inset-top);
            height: calc(50px + env(safe-area-inset-top));
        }

        /* CONTENT */
        .content {
            flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 150px;
            -webkit-overflow-scrolling: touch;
        }

        /* CARDS */
        .card {
            background: var(--card); border-radius: 16px; padding: 20px;
            margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        /* MODE BUTTONS */
        .mode-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn {
            flex: 1; padding: 15px; border-radius: 12px; background: var(--card);
            border: 2px solid transparent; text-align: center; cursor: pointer;
            font-weight: 600; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .mode-btn.active-practice { border-color: var(--primary); background: rgba(0,122,255,0.1); color: var(--primary); }
        .mode-btn.active-formulas { border-color: var(--purple); background: rgba(175,82,222,0.1); color: var(--purple); }
        .mode-btn.active-exam { border-color: var(--orange); background: rgba(255,159,10,0.1); color: var(--orange); }

        select {
            width: 100%; padding: 12px; font-size: 16px; border-radius: 10px;
            background: var(--bg); color: var(--text); border: 1px solid var(--border);
            margin-bottom: 20px; appearance: none;
        }

        .btn-start {
            width: 100%; padding: 16px; border-radius: 14px; border: none;
            font-size: 17px; font-weight: 700; color: white; background: var(--primary);
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .btn-start:active { transform: scale(0.97); }

        /* QUIZ */
        .q-meta { display: flex; justify-content: space-between; font-size: 13px; color: var(--subtext); margin-bottom: 10px; font-weight: 600; text-transform: uppercase; }
        .q-text { font-size: 19px; line-height: 1.4; margin-bottom: 25px; font-weight: 600; }

        .option {
            width: 100%; text-align: left; padding: 18px; margin-bottom: 12px;
            background: var(--bg); border: 2px solid transparent; border-radius: 14px;
            font-size: 16px; color: var(--text); cursor: pointer; transition: 0.1s; position: relative;
        }
        .option.correct { background: rgba(52, 199, 89, 0.15); border-color: var(--success); color: var(--text); }
        .option.wrong { background: rgba(255, 59, 48, 0.15); border-color: var(--error); color: var(--text); }
        .option.selected { background: rgba(0, 122, 255, 0.15); border-color: var(--primary); }
        
        body.mode-formulas .option.selected { background: rgba(175,82,222,0.15); border-color: var(--purple); }
        body.mode-exam .option.selected { background: rgba(255, 159, 10, 0.15); border-color: var(--orange); }

        /* SHORT EXPLANATION */
        .explanation {
            margin-top: 20px; padding: 15px; background: rgba(255, 204, 0, 0.15);
            border-radius: 12px; font-size: 15px; line-height: 1.4;
            border-left: 4px solid #ffcc00; display: none;
        }
        .explanation.show { display: block; }

        .btn-deep-dive {
            background: transparent; border: 1px solid var(--text); color: var(--text);
            padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600;
            margin-top: 10px; cursor: pointer; display: inline-block;
        }

        /* MODAL FOR DEEP DIVE */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: flex-end; /* Bottom sheet style */
        }
        .modal-overlay.open { display: flex; animation: slideUp 0.3s ease-out; }

        .modal-card {
            background: var(--card); width: 100%; max-height: 85vh;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 25px; overflow-y: auto; position: relative;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
        }

        .modal-close {
            position: absolute; top: 15px; right: 15px;
            background: var(--bg); border: none; width: 30px; height: 30px;
            border-radius: 50%; font-size: 18px; font-weight: bold; cursor: pointer; color: var(--subtext);
        }

        .deep-text { font-size: 16px; line-height: 1.6; color: var(--text); margin-top: 10px; }
        .deep-title { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 10px; }

        /* NAV */
        .floating-nav {
            position: fixed; bottom: 80px; left: 20px; right: 20px; height: 60px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            border-radius: 30px; display: flex; align-items: center; justify-content: space-between;
            padding: 5px; box-shadow: var(--shadow); z-index: 999;
            border: 1px solid rgba(255,255,255,0.2);
        }
        @media (prefers-color-scheme: dark) { .floating-nav { background: rgba(40,40,40,0.85); border-color: rgba(255,255,255,0.1); } }

        .nav-btn {
            width: 50px; height: 50px; border-radius: 25px; border: none;
            background: transparent; color: var(--text); font-size: 20px; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .nav-btn.primary { background: var(--primary); color: white; width: auto; padding: 0 25px; flex: 1; margin: 0 5px; font-size: 17px; transition: 0.3s; }

        .hidden { display: none !important; }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div>ATPL <span style="color:var(--primary)">DEEP DIVE</span></div>
    <div id="qCounter" style="font-size:14px; color:var(--subtext);">v17.0</div>
</header>

<div id="view-dashboard" class="content">
    <div class="card">
        <h2 style="margin-top:0">Training Setup</h2>
        <div style="font-size:13px; color:var(--subtext); margin-bottom:20px;">Chapters 1-10 (Focused)</div>

        <label style="font-size:13px; font-weight:600; margin-bottom:5px; display:block;">MODE</label>
        <div class="mode-row">
            <div class="mode-btn active-practice" id="m-practice" onclick="app.setMode('practice')">üéì Practice</div>
            <div class="mode-btn" id="m-formulas" onclick="app.setMode('formulas')">üìê Formulas</div>
        </div>
        <div class="mode-btn" id="m-exam" onclick="app.setMode('exam')" style="margin-bottom:20px;">‚è±Ô∏è Exam Simulation</div>

        <div id="diff-box">
            <label style="font-size:13px; font-weight:600; margin-bottom:5px; display:block;">DIFFICULTY</label>
            <select id="diff-select">
                <option value="easy">Easy (PPL Base)</option>
                <option value="medium" selected>Medium (ATPL Standard)</option>
                <option value="hard">Hard (Deep Theory)</option>
            </select>
        </div>

        <label style="font-size:13px; font-weight:600; margin-bottom:5px; display:block;">QUESTIONS</label>
        <select id="count-select">
            <option value="10">10 Questions</option>
            <option value="20" selected>20 Questions</option>
            <option value="40">40 Questions</option>
        </select>

        <button class="btn-start" id="btnStart" onclick="app.start()">START SESSION</button>
        <div style="text-align:center; margin-top:20px;">
            <a href="#" onclick="app.resetData()" style="color:var(--subtext); font-size:12px;">Reset History</a>
        </div>
    </div>
</div>

<div id="view-quiz" class="content hidden">
    <div class="card" id="quizCard">
        <div class="q-meta">
            <span id="qTopic">TOPIC</span>
            <span id="qLevel" style="color:var(--primary)">LEVEL</span>
        </div>
        <div class="q-text" id="qText">...</div>
        <div id="options-box"></div>
        
        <div id="explanation" class="explanation">
            <span id="short-exp-text"></span>
            <br>
            <button class="btn-deep-dive" onclick="app.showDeepDive()">üìñ Deep Dive</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="deepModal" onclick="app.closeDeepDive(event)">
    <div class="modal-card">
        <button class="modal-close" onclick="app.closeDeepDive(null)">‚úï</button>
        <div class="deep-title">Detailed Explanation</div>
        <div class="deep-text" id="long-exp-text"></div>
        <div style="margin-top:30px; text-align:center;">
            <button class="btn-start" onclick="app.closeDeepDive(null)">Close</button>
        </div>
    </div>
</div>

<div id="nav-bar" class="floating-nav hidden">
    <button class="nav-btn" onclick="app.prev()">‚Üê</button>
    <button class="nav-btn primary" id="btnAction" onclick="app.next()">Next</button>
    <button class="nav-btn" onclick="app.abort()">‚úï</button>
</div>

<div id="view-result" class="content hidden" style="text-align:center;">
    <div class="card">
        <h2>Session Complete</h2>
        <div style="font-size:40px; font-weight:800; color:var(--primary); margin:30px 0;" id="scoreVal">0%</div>
        <p id="scoreMsg" style="font-weight:600; font-size:18px;">Passed</p>
        <button class="btn-start" onclick="location.reload()">New Session</button>
    </div>
</div>

<script>
/* * DATABASE: CH 1-10 ONLY (No High Speed, No Mechanics, No Props)
 * Includes 'longExp' for detailed popup.
 */
const DB = [
    // --- CH1: DEFINITIONS ---
    { 
        id: "D01", topic: "Definitions", level: "easy", 
        q: "The SI unit of mass is the:", options: ["Newton", "Kilogram", "Joule", "Watt"], ans: 1, 
        exp: "Mass is measured in Kg. Weight is a force (Newton).",
        longExp: "Mass is a scalar quantity representing the amount of matter in an object. Its SI unit is the Kilogram (kg). Weight, often confused with mass, is the force of gravity acting on that mass (W = m * g) and is measured in Newtons (N). Joules measure Energy, Watts measure Power."
    },
    { 
        id: "D02", topic: "Definitions", level: "medium", 
        q: "Kinetic Energy is calculated as:", options: ["m*g*h", "1/2 m V¬≤", "F*d", "m*a"], ans: 1, 
        exp: "Energy of motion depends on mass and velocity squared.",
        longExp: "Kinetic Energy (KE) represents the energy an object possesses due to its motion. The formula KE = 1/2 * mass * velocity¬≤ shows that energy increases linearly with mass but exponentially with speed. Doubling your speed quadruples the energy (and thus the braking distance needed)."
    },
    {
        id: "D03", topic: "Definitions", level: "medium", 
        q: "Newton's First Law (Inertia) states:", options: ["F = m*a", "Action = Reaction", "Body remains at rest/uniform motion unless acted on", "Energy is conserved"], ans: 2, 
        exp: "A body resists changes to its state of motion.",
        longExp: "Newton's First Law is the Law of Inertia. It explains that an aircraft will maintain a constant speed and heading (equilibrium) unless an external force (like drag, thrust, or a turn input) acts upon it. Equilibrium does not mean stationary; it means zero acceleration."
    },

    // --- CH2: ATMOSPHERE ---
    { 
        id: "A01", topic: "Atmosphere", level: "medium", 
        q: "As altitude increases in the troposphere, density:", options: ["Increases", "Decreases", "Remains constant", "Fluctuates"], ans: 1, 
        exp: "Pressure drop dominates over temperature drop.",
        longExp: "Density (œÅ) is determined by Pressure (P) and Temperature (T) via the Gas Law (P = œÅRT). As we climb, Temperature drops (which would theoretically increase density), but Pressure drops MUCH faster. The pressure drop dominates, causing a net reduction in air density with altitude."
    },
    {
        id: "A02", topic: "Atmosphere", level: "hard", 
        q: "Density Altitude is:", options: ["Pressure Altitude corrected for Temperature", "Indicated Altitude", "Height AGL", "True Altitude"], ans: 0, 
        exp: "It is the altitude in the ISA where current density is found.",
        longExp: "Density Altitude is the single most important metric for performance. It answers: 'At what altitude does the aircraft FEEL like it is flying?'. If it is hot and humid, the air is thin (low density). The aircraft performs as if it were at a much higher altitude. Calculation: DA = Pressure Alt + (120 * (OAT - ISA_standard))."
    },
    {
        id: "A03", topic: "Atmosphere", level: "hard", 
        q: "High Humidity causes Density Altitude to:", options: ["Increase", "Decrease", "Stay same", "Zero"], ans: 0, 
        exp: "Water vapor is lighter than dry air (N2/O2).",
        longExp: "Counter-intuitively, humid air is LESS dense than dry air. Water vapor molecules (H2O, mass 18) displace Nitrogen (N2, mass 28) and Oxygen (O2, mass 32). Since the air mass is lighter per unit volume, density decreases, and Density Altitude INCREASES (Performance goes down)."
    },

    // --- CH3: BASIC AERO ---
    {
        id: "B01", topic: "Basic Aero", level: "medium", 
        q: "Bernoulli's Theorem implies that in a streamtube:", options: ["Total Pressure is constant", "Static Pressure is constant", "Density is constant", "Temp is constant"], ans: 0, 
        exp: "Sum of Static and Dynamic pressure is constant (incompressible flow).",
        longExp: "Bernoulli's Principle states that for an inviscid, incompressible fluid, the Total Energy (Total Pressure) remains constant along a streamline. Pt = Ps + q. If velocity increases (dynamic pressure 'q' goes up), static pressure 'Ps' MUST go down to keep the total constant."
    },
    {
        id: "B02", topic: "Basic Aero", level: "easy", 
        q: "The Equation of Continuity (A1V1 = A2V2) relates:", options: ["Area and Velocity", "Pressure and Temp", "Lift and Drag", "Mass and Force"], ans: 0, 
        exp: "Mass flow in = Mass flow out.",
        longExp: "The Continuity Equation states that mass cannot be created or destroyed. If a fluid flows through a tube that gets narrower (Area decreases), the fluid MUST speed up (Velocity increases) to let the same amount of mass pass through in the same time."
    },

    // --- CH4: LIFT ---
    {
        id: "L01", topic: "Lift", level: "hard", 
        q: "On a cambered aerofoil, as AoA increases, the Centre of Pressure (CP):", options: ["Moves Forward", "Moves Aft", "Stays Stationary", "Moves to Tip"], ans: 0, 
        exp: "The suction peak moves towards the leading edge.",
        longExp: "On a positively cambered wing, at low angles of attack, the lift is distributed evenly. As AoA increases, the point of lowest pressure (suction peak) moves sharply towards the leading edge. Consequently, the Centre of Pressure (the point where total Lift acts) moves FORWARD. This is destabilizing."
    },
    {
        id: "L02", topic: "Lift", level: "medium", 
        q: "The Aerodynamic Centre (AC) is located at:", options: ["25% Chord", "50% Chord", "Leading Edge", "Trailing Edge"], ans: 0, 
        exp: "Point where Pitching Moment is constant.",
        longExp: "The Aerodynamic Centre (AC) is a fixed point (approx 25% MAC in subsonic flight) where the pitching moment coefficient (Cm) does not change with Angle of Attack. Lift is usually modeled as acting at the AC with an associated pitching moment, rather than at the moving CP."
    },
    {
        id: "L03", topic: "Lift", level: "medium", 
        q: "Aspect Ratio is defined as:", options: ["Span¬≤ / Area", "Chord / Span", "Area / Span", "Thickness / Chord"], ans: 0, 
        exp: "Also Span / Mean Chord.",
        longExp: "Aspect Ratio (AR) describes the slenderness of a wing. A glider has a high AR (long, thin wings), while a fighter jet has low AR. High AR reduces Induced Drag significantly because it reduces the strength of wingtip vortices relative to the lift generated."
    },

    // --- CH5: DRAG ---
    {
        id: "DG01", topic: "Drag", level: "medium", 
        q: "Induced Drag is inversely proportional to:", options: ["V¬≤", "V", "Weight", "Aspect Ratio"], ans: 0, 
        exp: "Slower speed = Higher Induced Drag.",
        longExp: "Induced Drag is the 'cost' of creating lift. At low speeds, you need a high Angle of Attack to maintain lift. High AoA creates strong pressure differentials at the wingtips, leading to strong vortices and high Induced Drag. Formula: Di ‚àù 1/V¬≤. As you speed up, AoA drops, and Induced Drag vanishes."
    },
    {
        id: "DG02", topic: "Drag", level: "medium", 
        q: "Parasite Drag increases with:", options: ["V¬≤", "1/V¬≤", "Altitude", "Weight"], ans: 0, 
        exp: "Faster speed = Higher air resistance.",
        longExp: "Parasite Drag includes Form drag, Skin Friction, and Interference drag. It is simply the air resistance of moving through the fluid. Like putting your hand out of a car window, the force increases with the square of the speed (V¬≤). Double speed = 4x Drag."
    },
    {
        id: "DG03", topic: "Drag", level: "hard", 
        q: "Vmd (Minimum Drag speed) occurs where:", options: ["Induced Drag = Parasite Drag", "Parasite Drag is zero", "Lift is Max", "Stall occurs"], ans: 0, 
        exp: "The bottom of the Total Drag curve.",
        longExp: "The Total Drag curve is U-shaped. On the left side (low speed), Induced Drag dominates. On the right side (high speed), Parasite Drag dominates. The lowest point (Minimum Drag) is mathematically exactly where the two curves cross. Flying at Vmd gives the best Glide Ratio."
    },

    // --- CH6: STALLING ---
    {
        id: "S01", topic: "Stalling", level: "easy", 
        q: "Stall depends ONLY on:", options: ["Angle of Attack", "Airspeed", "Weight", "Bank Angle"], ans: 0, 
        exp: "The Critical Angle of Attack.",
        longExp: "An aircraft can stall at any speed, any attitude, and any power setting. The ONLY condition for a stall is exceeding the Critical Angle of Attack (CLmax). Weight and Load Factor change the SPEED at which this angle is reached, but the angle itself is fixed for a given configuration."
    },
    {
        id: "S02", topic: "Stalling", level: "hard", 
        q: "In a 60¬∞ bank level turn, Stall Speed increases by:", options: ["41%", "10%", "100%", "20%"], ans: 0, 
        exp: "Load Factor is 2g. Increase is ‚àö2.",
        longExp: "In a level turn, Lift must support Weight AND provide centripetal force. Load Factor (n) = 1/cos(60¬∞) = 2g. The stall speed increases by the square root of the load factor. ‚àö2 = 1.41. So Vs increases by a factor of 1.41, or +41%."
    },
    {
        id: "S03", topic: "Stalling", level: "medium", 
        q: "A Forward CG location:", options: ["Increases Stall Speed", "Decreases Stall Speed", "Makes recovery harder", "Reduces Stability"], ans: 0, 
        exp: "Tail must create more downforce.",
        longExp: "With a forward CG, the tailplane must generate significant DOWNFORCE to balance the nose-down moment. This downforce adds to the effective weight the wings must support (Lift = Weight + TailDownforce). More lift required means a higher Angle of Attack is needed for a given speed, causing the wing to reach the critical angle sooner (Higher Vs)."
    },

    // --- CH7: HIGH LIFT ---
    {
        id: "H01", topic: "High Lift", level: "easy", 
        q: "Trailing Edge Flaps primarily increase:", options: ["Camber", "Aspect Ratio", "Speed", "Stability"], ans: 0, 
        exp: "They increase CLmax by curving the wing.",
        longExp: "Flaps increase the camber (curvature) of the wing profile. This shifts the Lift Curve up and to the left, increasing CLmax significantly. This allows the aircraft to fly slower without stalling. They also add Drag, which helps steeper approaches."
    },
    {
        id: "H02", topic: "High Lift", level: "hard", 
        q: "Leading Edge Slats work by:", options: ["Re-energizing the boundary layer", "Increasing Area", "Blocking airflow", "Acting as a brake"], ans: 0, 
        exp: "Allow high pressure air to flow to upper surface.",
        longExp: "Slats open a slot at the leading edge. High-pressure air from beneath the wing accelerates through this slot and injects high-energy air into the boundary layer on the top surface. This delays flow separation, allowing the wing to reach much higher Angles of Attack before stalling."
    },

    // --- CH8: STABILITY ---
    {
        id: "ST01", topic: "Stability", level: "easy", 
        q: "Static Stability refers to:", options: ["Initial tendency to return to equilibrium", "Oscillation over time", "Control forces", "Manoeuvrability"], ans: 0, 
        exp: "Static = Initial reaction. Dynamic = Time history.",
        longExp: "Static stability is the immediate initial response to a disturbance. If the nose is pushed up, a statically stable plane initially tries to push it back down. Dynamic stability concerns what happens next: does it dampen out (stable), oscillate forever (neutral), or get worse (unstable)?"
    },
    {
        id: "ST02", topic: "Stability", level: "medium", 
        q: "Longitudinal Stability is determined by:", options: ["CG position vs Neutral Point", "Wing span", "Rudder size", "Ailerons"], ans: 0, 
        exp: "Relationship between Center of Gravity and Aerodynamic Center.",
        longExp: "Longitudinal (Pitch) stability depends on the distance between the CG and the Neutral Point (Aerodynamic Center of the whole aircraft). The CG must be FORWARD of the Neutral Point. The tailplane provides the stabilizing force to counter this moment."
    },
    {
        id: "ST03", topic: "Stability", level: "hard", 
        q: "Dutch Roll is caused by:", options: ["Lateral Stability > Directional Stability", "Directional > Lateral", "Forward CG", "Low speed"], ans: 0, 
        exp: "Strong Dihedral vs Weak Fin.",
        longExp: "Dutch Roll is an oscillatory instability. It happens when the aircraft has very strong Lateral Stability (wants to roll level quickly due to Dihedral/Sweep) but weak Directional Stability (Small Fin). The aircraft rolls and yaws out of phase, wagging its tail."
    },

    // --- CH9: CONTROLS ---
    {
        id: "C01", topic: "Controls", level: "medium", 
        q: "Adverse Yaw is caused by:", options: ["Induced Drag on the up-going wing", "Rudder misalignment", "Torque", "Slipstream"], ans: 0, 
        exp: "The wing that produces more lift (going up) produces more drag.",
        longExp: "When you roll right, the left aileron goes down to increase lift on the left wing. Increased lift creates increased Induced Drag. This drag pulls the nose to the LEFT (opposite the turn). This is Adverse Yaw. It is countered by Differential Ailerons or Frise Ailerons."
    },
    {
        id: "C02", topic: "Controls", level: "hard", 
        q: "Mass Balance is used to prevent:", options: ["Flutter", "Stall", "Spin", "Adverse Yaw"], ans: 0, 
        exp: "Aligns control surface CG with Hinge Line.",
        longExp: "Flutter is a dangerous, explosive oscillation of control surfaces caused by aeroelasticity. It happens if the control surface's Center of Gravity is behind its hinge line. Mass Balancing adds weights forward of the hinge to move the CG onto or ahead of the hinge line, preventing flutter."
    },

    // --- FORMULAS (Ch 1-10 Relevant) ---
    { id: "F01", topic: "Formulas", level: "medium", q: "Lift Equation:", options: ["L = 1/2 œÅ V¬≤ CL S", "L = W * g", "L = œÅ V S", "L = 1/2 V S"], ans: 0, exp: "Dynamic Pressure x CL x S.", longExp: "L = 1/2 * Density * Velocity¬≤ * Coefficient of Lift * Wing Area. This formula is fundamental. It shows Lift increases with the square of speed." },
    { id: "F02", topic: "Formulas", level: "hard", q: "Stall Speed vs Weight:", options: ["Vs2 = Vs1 * ‚àö(W2/W1)", "Vs doubles with weight", "Linear", "No change"], ans: 0, exp: "Vs ~ ‚àöWeight.", longExp: "Since Lift must equal Weight, and Lift depends on V¬≤, Velocity depends on the square root of Weight. If you quadruple weight, stall speed doubles." },
    { id: "F03", topic: "Formulas", level: "hard", q: "Load Factor (n) in level turn:", options: ["1 / cos(œÜ)", "sin(œÜ)", "tan(œÜ)", "1 / sin(œÜ)"], ans: 0, exp: "Depends only on Bank Angle.", longExp: "In a level turn, the vertical component of lift must support weight. Lift = Weight / cos(BankAngle). Load Factor n = Lift/Weight, so n = 1/cos(Bank)." },
    { id: "F04", topic: "Formulas", level: "medium", q: "Dynamic Pressure (q):", options: ["1/2 œÅ V¬≤", "œÅ V", "1/2 P", "V¬≤"], ans: 0, exp: "Kinetic energy per unit volume.", longExp: "Dynamic pressure represents the air impact force. It is the difference between Total (Pitot) Pressure and Static Pressure." },
    { id: "F05", topic: "Formulas", level: "medium", q: "Aspect Ratio:", options: ["Span¬≤ / Area", "Chord / Span", "Area / Span", "Thickness / Chord"], ans: 0, exp: "Or Span / Mean Chord.", longExp: "Geometric ratio of the wing. High Aspect Ratio (long skinny wings) reduces Induced Drag." }
];

/* --- LOGIC ENGINE --- */
const app = {
    state: { mode: 'practice', pool: [], idx: 0, answers: [], used: JSON.parse(localStorage.getItem('ATPL_V17') || "[]") },

    init: function() { },

    setMode: function(m) {
        this.state.mode = m;
        document.querySelectorAll('.mode-btn').forEach(b => {
            b.classList.remove('active-practice', 'active-formulas', 'active-exam');
        });
        document.getElementById('m-'+m).classList.add('active-'+m);
        
        document.body.classList.remove('mode-formulas', 'mode-exam');
        if(m === 'formulas') document.body.classList.add('mode-formulas');
        if(m === 'exam') document.body.classList.add('mode-exam');

        // Toggle Difficulty visibility
        const diffBox = document.getElementById('diff-box');
        if(m === 'practice') diffBox.style.display = 'block';
        else diffBox.style.display = 'none';

        // Button Color Update
        const btn = document.getElementById('btnStart');
        btn.style.boxShadow = "none";
        if(m === 'practice') { btn.style.backgroundColor = "var(--primary)"; btn.style.boxShadow = "0 4px 10px rgba(0, 122, 255, 0.3)"; }
        else if (m === 'formulas') { btn.style.backgroundColor = "var(--purple)"; btn.style.boxShadow = "0 4px 10px rgba(175, 82, 222, 0.3)"; }
        else { btn.style.backgroundColor = "var(--orange)"; btn.style.boxShadow = "0 4px 10px rgba(255, 159, 10, 0.3)"; }
    },

    start: function() {
        const count = parseInt(document.getElementById('count-select').value);
        const diff = document.getElementById('diff-select').value;
        
        let candidates = DB;
        
        if (this.state.mode === 'formulas') candidates = DB.filter(q => q.topic === 'Formulas');
        else if (this.state.mode === 'practice') {
            let specific = DB.filter(q => q.level === diff);
            if (specific.length >= count) candidates = specific;
        }
        
        candidates.sort(() => Math.random() - 0.5);
        this.state.pool = candidates.slice(0, count);
        this.state.answers = new Array(this.state.pool.length).fill(null);
        this.state.idx = 0;

        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-quiz').classList.remove('hidden');
        document.getElementById('nav-bar').classList.remove('hidden');
        
        this.loadQ();
    },

    loadQ: function() {
        const q = this.state.pool[this.state.idx];
        const ans = this.state.answers[this.state.idx];
        
        document.getElementById('qCounter').innerText = `${this.state.idx + 1} / ${this.state.pool.length}`;
        document.getElementById('qTopic').innerText = (this.state.mode === 'formulas') ? "FORMULA" : q.topic;
        document.getElementById('qLevel').innerText = q.level.toUpperCase();
        document.getElementById('qText').innerText = q.q;
        
        const c = document.getElementById('options-box');
        c.innerHTML = '';
        const exp = document.getElementById('explanation');
        exp.classList.remove('show');

        q.options.forEach((opt, i) => {
            const btn = document.createElement('div');
            btn.className = 'option';
            btn.innerText = opt;
            btn.onclick = () => this.handleAnswer(i, btn, q);
            
            if (this.state.mode !== 'exam') {
                if (ans !== null) {
                    if (i === q.ans) btn.classList.add('correct');
                    else if (i === ans) btn.classList.add('wrong');
                }
            } else {
                if (ans === i) btn.classList.add('selected');
            }
            c.appendChild(btn);
        });

        // SHORT EXP LOGIC
        if (this.state.mode !== 'exam' && ans !== null) {
            document.getElementById('short-exp-text').innerHTML = `<strong>Answer:</strong> ${q.exp}`;
            exp.classList.add('show');
        }

        const btnAct = document.getElementById('btnAction');
        if (this.state.idx === this.state.pool.length - 1) {
            btnAct.innerText = (this.state.mode === 'exam') ? "Submit" : "Finish";
            btnAct.style.backgroundColor = (this.state.mode === 'exam') ? "var(--orange)" : "var(--error)";
        } else {
            btnAct.innerText = "Next";
            btnAct.style.backgroundColor = "var(--primary)";
        }
    },

    handleAnswer: function(i, btn, q) {
        if (this.state.mode !== 'exam' && this.state.answers[this.state.idx] !== null) return;
        this.state.answers[this.state.idx] = i;
        this.loadQ();
    },

    // --- DEEP DIVE MODAL LOGIC ---
    showDeepDive: function() {
        const q = this.state.pool[this.state.idx];
        document.getElementById('long-exp-text').innerText = q.longExp || "No detailed explanation available for this question.";
        document.getElementById('deepModal').classList.add('open');
    },

    closeDeepDive: function(e) {
        if (e && e.target !== e.currentTarget && e.target.tagName !== 'BUTTON') return; // Click inside card shouldn't close unless button
        document.getElementById('deepModal').classList.remove('open');
    },

    next: function() {
        if (this.state.idx < this.state.pool.length - 1) {
            this.state.idx++;
            this.loadQ();
        } else {
            this.finish();
        }
    },

    prev: function() {
        if (this.state.idx > 0) {
            this.state.idx--;
            this.loadQ();
        }
    },

    finish: function() {
        if (this.state.mode === 'exam' && !confirm("Submit Exam?")) return;

        let correct = 0;
        this.state.answers.forEach((a, i) => {
            if (a === this.state.pool[i].ans) correct++;
        });
        
        const pct = Math.round((correct / this.state.pool.length) * 100);
        
        document.getElementById('view-quiz').classList.add('hidden');
        document.getElementById('nav-bar').classList.add('hidden');
        document.getElementById('view-result').classList.remove('hidden');
        
        const scoreEl = document.getElementById('scoreVal');
        const msgEl = document.getElementById('scoreMsg');
        
        scoreEl.innerText = pct + "%";
        if(pct >= 75) {
            scoreEl.style.color = "var(--success)";
            scoreEl.style.borderColor = "var(--success)";
            msgEl.innerText = "PASSED";
            msgEl.style.color = "var(--success)";
        } else {
            scoreEl.style.color = "var(--error)";
            scoreEl.style.borderColor = "var(--error)";
            msgEl.innerText = "FAILED";
            msgEl.style.color = "var(--error)";
        }
    },
    
    resetData: function() {
        if(confirm("Reset all history?")) {
            localStorage.removeItem('ATPL_V17');
            location.reload();
        }
    },

    abort: function() {
        if(confirm("Quit session?")) location.reload();
    }
};

app.init();
</script>
</body>
</html>