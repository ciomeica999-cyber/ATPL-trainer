<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ATPL PRO v18</title>
    <style>
        :root {
            --primary: #007aff; --orange: #ff9f0a; --purple: #af52de;
            --bg: #f2f2f7; --card: #ffffff; --text: #000000;
            --subtext: #6c6c70; --border: #c6c6c8;
            --success: #34c759; --error: #ff3b30;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #0a84ff; --orange: #ff9f0a; --purple: #bf5af2;
                --bg: #000000; --card: #1c1c1e; --text: #ffffff;
                --subtext: #aeaeb2; --border: #38383a;
                --shadow: 0 4px 20px rgba(0,0,0,0.4);
            }
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; padding: 0; background-color: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { height: 50px; background: var(--card); border-bottom: 0.5px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; font-weight: 700; font-size: 17px; z-index: 10; padding-top: env(safe-area-inset-top); height: calc(50px + env(safe-area-inset-top)); }
        
        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 150px; -webkit-overflow-scrolling: touch; }
        
        .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        
        .mode-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 15px; border-radius: 12px; background: var(--card); border: 2px solid transparent; text-align: center; cursor: pointer; font-weight: 600; font-size: 15px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .mode-btn.active-practice { border-color: var(--primary); background: rgba(0,122,255,0.1); color: var(--primary); }
        .mode-btn.active-formulas { border-color: var(--purple); background: rgba(175,82,222,0.1); color: var(--purple); }
        .mode-btn.active-exam { border-color: var(--orange); background: rgba(255,159,10,0.1); color: var(--orange); }
        
        select { width: 100%; padding: 12px; font-size: 16px; border-radius: 10px; background: var(--bg); color: var(--text); border: 1px solid var(--border); margin-bottom: 20px; appearance: none; }
        
        .btn-start { width: 100%; padding: 16px; border-radius: 14px; border: none; font-size: 17px; font-weight: 700; color: white; background: var(--primary); cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn-start:active { transform: scale(0.97); }
        
        .q-meta { display: flex; justify-content: space-between; font-size: 12px; color: var(--subtext); margin-bottom: 10px; font-weight: 600; text-transform: uppercase; }
        .q-text { font-size: 18px; line-height: 1.4; margin-bottom: 25px; font-weight: 600; }
        
        .option { width: 100%; text-align: left; padding: 18px; margin-bottom: 12px; background: var(--bg); border: 2px solid transparent; border-radius: 14px; font-size: 16px; color: var(--text); cursor: pointer; transition: 0.1s; position: relative; }
        .option.correct { background: rgba(52, 199, 89, 0.15); border-color: var(--success); }
        .option.wrong { background: rgba(255, 59, 48, 0.15); border-color: var(--error); }
        .option.selected { background: rgba(0, 122, 255, 0.15); border-color: var(--primary); }
        
        body.mode-formulas .option.selected { border-color: var(--purple); background: rgba(175,82,222,0.15); }
        body.mode-exam .option.selected { border-color: var(--orange); background: rgba(255,159,10,0.15); }
        
        .explanation { margin-top: 20px; padding: 15px; background: rgba(255, 204, 0, 0.15); border-radius: 12px; font-size: 15px; line-height: 1.4; border-left: 4px solid #ffcc00; display: none; }
        .explanation.show { display: block; }
        
        .btn-deep-dive { background: transparent; border: 1px solid var(--text); color: var(--text); padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-top: 10px; cursor: pointer; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: flex-end; }
        .modal-overlay.open { display: flex; animation: slideUp 0.3s ease-out; }
        .modal-card { background: var(--card); width: 100%; max-height: 85vh; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 25px; overflow-y: auto; position: relative; }
        .deep-title { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 10px; }
        .deep-text { font-size: 16px; line-height: 1.6; }
        
        .floating-nav { position: fixed; bottom: 80px; left: 20px; right: 20px; height: 60px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-radius: 30px; display: flex; align-items: center; justify-content: space-between; padding: 5px; box-shadow: var(--shadow); z-index: 999; border: 1px solid rgba(255,255,255,0.2); }
        @media (prefers-color-scheme: dark) { .floating-nav { background: rgba(40,40,40,0.85); } }
        
        .nav-btn { width: 50px; height: 50px; border-radius: 25px; border: none; background: transparent; color: var(--text); font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .nav-btn.primary { background: var(--primary); color: white; width: auto; padding: 0 25px; flex: 1; margin: 0 5px; font-size: 17px; }
        
        .hidden { display: none !important; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div>ATPL <span style="color:var(--primary)">PRO v18</span></div>
    <div id="qCounter" style="font-size:14px; color:var(--subtext);">Ready</div>
</header>

<div id="view-dashboard" class="content">
    <div class="card">
        <h2 style="margin-top:0">Study Plan: Ch 1-10</h2>
        <div style="font-size:13px; color:var(--subtext); margin-bottom:20px;" id="dbInfo">Loading Questions...</div>
        
        <div class="mode-row">
            <div class="mode-btn active-practice" id="m-practice" onclick="app.setMode('practice')">üéì Practice</div>
            <div class="mode-btn" id="m-formulas" onclick="app.setMode('formulas')">üìê Formulas</div>
        </div>
        <div class="mode-btn" id="m-exam" onclick="app.setMode('exam')" style="margin-bottom:20px;">‚è±Ô∏è Exam Mode</div>
        
        <div id="diff-box">
            <select id="diff-select">
                <option value="easy">Easy (PPL Level)</option>
                <option value="medium" selected>Medium (ATPL Standard)</option>
                <option value="hard">Hard (Advanced Theory)</option>
            </select>
        </div>
        
        <select id="count-select">
            <option value="10">10 Questions</option>
            <option value="20" selected>20 Questions</option>
            <option value="50">50 Questions</option>
            <option value="100">100 Questions</option>
        </select>
        
        <button class="btn-start" id="btnStart" onclick="app.start()">START SESSION</button>
        <div style="text-align:center; margin-top:20px;">
            <a href="#" onclick="app.resetData()" style="color:var(--subtext); font-size:12px;">Reset History</a>
        </div>
    </div>
</div>

<div id="view-quiz" class="content hidden">
    <div class="card">
        <div class="q-meta"><span id="qTopic">TOPIC</span><span id="qLevel" style="color:var(--primary)">LEVEL</span></div>
        <div class="q-text" id="qText">...</div>
        <div id="options-box"></div>
        <div id="explanation" class="explanation">
            <span id="short-exp"></span><br>
            <button class="btn-deep-dive" onclick="app.showDeepDive()">üìñ Deep Dive</button>
        </div>
    </div>
</div>

<div id="nav-bar" class="floating-nav hidden">
    <button class="nav-btn" onclick="app.prev()">‚Üê</button>
    <button class="nav-btn primary" id="btnAction" onclick="app.next()">Next</button>
    <button class="nav-btn" onclick="app.abort()">‚úï</button>
</div>

<div class="modal-overlay" id="deepModal" onclick="app.closeDeepDive(event)">
    <div class="modal-card">
        <div class="deep-title">Theoretical Deep Dive</div>
        <div class="deep-text" id="long-exp"></div>
        <button class="btn-start" style="margin-top:30px;" onclick="app.closeDeepDive(null)">Understood</button>
    </div>
</div>

<div id="view-result" class="content hidden" style="text-align:center;">
    <div class="card">
        <h2>Session Results</h2>
        <div style="font-size:48px; font-weight:800; margin:30px 0; color:var(--primary)" id="scoreVal">0%</div>
        <p id="scoreMsg" style="font-weight:600;"></p>
        <button class="btn-start" onclick="location.reload()">Return Home</button>
    </div>
</div>

<script>
const DB = [
    // --- CH1: PHYSICS ---
    { id: "C1_01", topic: "Definitions", level: "easy", q: "The SI unit of force is the:", options: ["Newton", "Kilogram", "Joule", "Pascal"], ans: 0, exp: "F = m * a. Force is measured in Newtons.", longExp: "A Newton is defined as the force required to accelerate a 1kg mass at 1 m/s¬≤. In aviation, Weight is a force acting downwards ($W = m \\cdot g$)." },
    { id: "C1_02", topic: "Definitions", level: "medium", q: "Kinetic Energy is defined as:", options: ["1/2 m V¬≤", "m g h", "F d", "m a"], ans: 0, exp: "Energy of motion depends on V¬≤.", longExp: "Kinetic Energy ($KE$) is the energy possessed by an object due to its motion. It is proportional to mass and the square of velocity. If you double your speed, your kinetic energy quadruples." },
    
    // --- CH2: ATMOSPHERE ---
    { id: "C2_01", topic: "Atmosphere", level: "medium", q: "As altitude increases in the troposphere, density:", options: ["Increases", "Decreases", "Remains constant", "Fluctuates"], ans: 1, exp: "Pressure drops faster than temperature.", longExp: "Density depends on Pressure and Temperature. While lower temperatures would increase density, the rapid drop in static pressure with altitude dominates, resulting in decreased density." },
    { id: "C2_02", topic: "Atmosphere", level: "hard", q: "Density Altitude is:", options: ["Pressure Altitude corrected for Temperature", "Height AGL", "True Altitude", "Indicated"], ans: 0, exp: "DA is the altitude in ISA where current density is found.", longExp: "If the air is warmer than standard, it is less dense. The aircraft performs as if it were at a higher altitude. This 'performance altitude' is Density Altitude." },
    { id: "C2_03", topic: "Atmosphere", level: "hard", q: "High humidity results in density that is:", options: ["Higher than dry air", "Lower than dry air", "The same", "Double"], ans: 1, exp: "Water vapor is lighter than Nitrogen/Oxygen.", longExp: "Water vapor ($H_2O$, mass 18) is lighter than $N_2$ (28) and $O_2$ (32). Humid air is therefore lighter and less dense than dry air, decreasing performance." },
    
    // --- CH3: BASIC AERO ---
    { id: "C3_01", topic: "Basic Aero", level: "medium", q: "Bernoulli's Theorem states:", options: ["Static + Dynamic Pressure = Constant", "Density is constant", "Temp is constant", "Lift = Weight"], ans: 0, exp: "Total Pressure remains constant in streamline flow.", longExp: "In an ideal fluid flow, as velocity increases (Dynamic Pressure rises), the Static Pressure must decrease to keep the Total Pressure constant." },
    { id: "C3_02", topic: "Basic Aero", level: "easy", q: "The Continuity Equation relates:", options: ["Area and Velocity", "Pressure and Temp", "Lift and Drag", "Force and Mass"], ans: 0, exp: "$A_1 V_1 = A_2 V_2$.", longExp: "Mass cannot be created or destroyed. If a tube narrows (Area decreases), the fluid must speed up (Velocity increases) to maintain the same mass flow rate." },

    // --- CH4: LIFT ---
    { id: "C4_01", topic: "Lift", level: "medium", q: "Lift formula:", options: ["$L = 1/2 \\rho V^2 S C_L$", "$L = \\rho V S$", "$L = W$", "$L = 1/2 V S$"], ans: 0, exp: "Depends on $V^2$, Density, Area, and $C_L$.", longExp: "This is the fundamental equation. Lift increases with the square of speed. It also depends linearly on air density ($\\rho$), wing area ($S$), and the lift coefficient ($C_L$)." },
    { id: "C4_02", topic: "Lift", level: "hard", q: "On a cambered aerofoil, if AoA increases, CP:", options: ["Moves Forward", "Moves Aft", "Stays stationary", "Moves to tip"], ans: 0, exp: "Suction peak moves to LE.", longExp: "As AoA increases, the point of lowest pressure moves forward on the upper surface. The Center of Pressure (resultant force) follows this, moving forward. This is destabilizing." },
    { id: "C4_03", topic: "Lift", level: "medium", q: "Aspect Ratio is:", options: ["Span / Mean Chord", "Chord / Span", "Thickness / Chord", "Area / Span"], ans: 0, exp: "$AR = b^2 / S$.", longExp: "Aspect Ratio describes the slenderness of a wing. High AR wings (gliders) are more efficient and produce less Induced Drag." },

    // --- CH5: DRAG ---
    { id: "C5_01", topic: "Drag", level: "hard", q: "Induced Drag is inversely proportional to:", options: ["$V^2$", "$V$", "$Weight$", "$Altitude$"], ans: 0, exp: "Formula: $D_i \\propto 1/V^2$.", longExp: "Induced drag is the cost of lift. At low speeds, high AoA is needed, creating strong vortices and high induced drag. As speed increases, AoA drops, and induced drag vanishes." },
    { id: "C5_02", topic: "Drag", level: "medium", q: "Parasite Drag consists of:", options: ["Skin Friction, Form, Interference", "Induced + Wave", "Lift drag", "Vortex drag"], ans: 0, exp: "Drag not associated with lift.", longExp: "Parasite drag increases with the square of speed ($V^2$). It includes the friction of air on the skin and the resistance of the aircraft's shape." },
    { id: "C5_03", topic: "Drag", level: "hard", q: "Minimum Drag speed ($V_{md}$):", options: ["Where Induced = Parasite Drag", "Parasite is zero", "Lift is max", "Stall"], ans: 0, exp: "Intersection of drag curves.", longExp: "At $V_{md}$, the total drag is at its lowest point. This speed provides the maximum Lift/Drag ratio and the best glide range." },

    // --- CH6: STALLING ---
    { id: "C6_01", topic: "Stalling", level: "easy", q: "Stall occurs when:", options: ["Critical AoA is exceeded", "Speed is too low", "Weight is too high", "Power is zero"], ans: 0, exp: "It is an AoA phenomenon.", longExp: "A wing stalls when the airflow separates from the upper surface because the angle of attack is too high. This can happen at ANY speed (e.g. high speed accelerated stall)." },
    { id: "C6_02", topic: "Stalling", level: "hard", q: "In a 60¬∞ bank turn, stall speed increases by:", options: ["41%", "20%", "100%", "10%"], ans: 0, exp: "Load factor is 2. Increase is $\\sqrt{2}$.", longExp: "In a 60¬∞ turn, Load Factor $n = 2g$. Stall speed increases by the square root of $n$. $\\sqrt{2} = 1.41$, so a 41% increase." },
    { id: "C6_03", topic: "Stalling", level: "medium", q: "Forward CG effect on Stall Speed:", options: ["Increases Vs", "Decreases Vs", "No effect", " Prevents stall"], ans: 0, exp: "Tail downforce increases effective weight.", longExp: "A forward CG requires the tail to produce more downforce to balance. The wings must support Weight + Tail Force. This higher load requires a higher AoA, reaching the critical angle sooner." },

    // --- CH7: HIGH LIFT ---
    { id: "H01", topic: "High Lift", level: "easy", q: "Flaps primarily increase:", options: ["Camber and $C_{Lmax}$", "Speed", "Stability", "Aspect Ratio"], ans: 0, exp: "Allows slower flight.", longExp: "Flaps increase the wing's curvature (camber), shifting the lift curve up. This increases the maximum lift coefficient, lowering the stall speed." },
    { id: "H02", topic: "High Lift", level: "hard", q: "Slats work by:", options: ["Re-energizing boundary layer", "Increasing area", "Blocking flow", "Braking"], ans: 0, exp: "Slot effect.", longExp: "Slats allow high-pressure air from below to accelerate through a slot, adding energy to the airflow on top. This delays separation and allows higher angles of attack." },

    // --- CH8: STABILITY ---
    { id: "S01", topic: "Stability", level: "easy", q: "Static Stability is:", options: ["Initial tendency to return", "Time to return", "Oscillation", "Control force"], ans: 0, exp: "Initial reaction.", longExp: "Static stability is the immediate response. If pushed nose-up, a stable plane initially tries to push nose-down." },
    { id: "S02", topic: "Stability", level: "medium", q: "Longitudinal Stability provided by:", options: ["Tailplane", "Ailerons", "Rudder", "Fin"], ans: 0, exp: "Pitch stability.", longExp: "The horizontal stabilizer provides the restoring force for pitch. Stability requires the CG to be forward of the Neutral Point." },
    { id: "S03", topic: "Stability", level: "hard", q: "Dutch Roll cause:", options: ["Strong Lateral / Weak Directional", "Weak Lateral / Strong Directional", "Fwd CG", "Stall"], ans: 0, exp: "Roll/Yaw oscillation.", longExp: "Occurs when Dihedral effect (roll stability) is much stronger than the Vertical Fin (directional stability)." },

    // --- CH9: CONTROLS ---
    { id: "CTL_01", topic: "Controls", level: "medium", q: "Adverse Yaw caused by:", options: ["Induced Drag on up-going wing", "Prop torque", "Rudder", "Slipstream"], ans: 0, exp: "More lift = More drag.", longExp: "The wing that rises (to roll) creates more lift, and thus more induced drag, pulling the nose opposite to the turn." },
    { id: "CTL_02", topic: "Controls", level: "hard", q: "Mass Balance prevents:", options: ["Flutter", "Stall", "Spin", "Yaw"], ans: 0, exp: "Moves CG to hinge line.", longExp: "Flutter is a dangerous aeroelastic oscillation. Placing weights forward of the control surface hinge prevents it." },

    // --- FORMULAS (MATH) ---
    { id: "F01", topic: "Formulas", level: "medium", q: "Load Factor ($n$):", options: ["$1 / \\cos(\\phi)$", "$\\sin(\\phi)$", "$\\tan(\\phi)$", "$1 / \\sin(\\phi)$"], ans: 0, exp: "Based on bank angle.", longExp: "In a level turn, the vertical lift component balances weight. $L = W / \\cos(\\phi)$, so Load Factor $n = L/W = 1/\\cos(\\phi)$." },
    { id: "F02", topic: "Formulas", level: "hard", q: "Stall Speed vs Weight:", options: ["$V_{s2} = V_{s1} \\cdot \\sqrt{W_2/W_1}$", "Linear", "Square", "No change"], ans: 0, exp: "Square root relationship.", longExp: "Since Lift equals Weight and Lift depends on $V^2$, Velocity is proportional to the square root of Weight." },
    { id: "F03", topic: "Formulas", level: "medium", q: "Dynamic Pressure ($q$):", options: ["$1/2 \\rho V^2$", "$\\rho V$", "$P_t$", "$V^2$"], ans: 0, exp: "Kinetic energy of air.", longExp: "Dynamic pressure represents the impact force of the air. It is the difference between Total and Static pressure." },
    { id: "F04", topic: "Formulas", level: "hard", q: "Turn Radius ($R$):", options: ["$V^2 / (g \\cdot \\tan \\phi)$", "$V / \\tan \\phi$", "$V \\cdot g$", "$V^2 / g$"], ans: 0, exp: "Increases with $V^2$.", longExp: "Higher speed drastically increases turn radius. A tighter bank angle reduces it." },
    
    // --- EXPANSION PACK (More Questions) ---
    { id: "E01", topic: "Definitions", level: "easy", q: "Power is defined as:", options: ["Work / Time", "Force x Time", "Mass x Accel", "Energy"], ans: 0, exp: "Rate of doing work.", longExp: "Power is the rate at which work is done ($P = Work/t$ or $P = Force \\cdot Velocity$)." },
    { id: "E02", topic: "Atmosphere", level: "medium", q: "QNH is:", options: ["Pressure corrected to MSL", "Height above runway", "Standard Pressure", "Density"], ans: 0, exp: "Nautical Height.", longExp: "QNH is the barometric pressure adjusted to Mean Sea Level. Setting QNH makes the altimeter read altitude above sea level." },
    { id: "E03", topic: "Lift", level: "hard", q: "Geometric Washout means:", options: ["Twist: Root AoA > Tip AoA", "Tip AoA > Root", "No twist", "Dihedral"], ans: 0, exp: "Prevents tip stall.", longExp: "The wing is twisted so the tip has a lower angle of incidence than the root. This ensures the root stalls first, keeping ailerons effective." },
    { id: "E04", topic: "Drag", level: "medium", q: "L/D Max occurs at:", options: ["$4^\circ$ AoA (approx)", "16 degrees", "0 degrees", "Stall"], ans: 0, exp: "Most efficient angle.", longExp: "For most GA aircraft, the best Lift/Drag ratio occurs at an Angle of Attack of around 4 degrees." },
    { id: "E05", topic: "Stalling", level: "hard", q: "Spin Recovery (Standard):", options: ["Power Idle, Opposite Rudder, Stick Fwd", "Power Max, Stick Back", "Ailerons into spin", "Wait"], ans: 0, exp: "PARE method.", longExp: "Power Idle (reduce radius), Ailerons Neutral, Rudder Opposite (stop rotation), Elevator Forward (break stall)." },
    { id: "E06", topic: "Stability", level: "medium", q: "Aft CG makes the aircraft:", options: ["Less stable, more efficient", "More stable", "Slower", "Heavier"], ans: 0, exp: "Lower tail downforce.", longExp: "Aft CG reduces the stabilizer lever arm (unstable) but requires less downforce, reducing induced drag (efficient)." },
    { id: "E07", topic: "Controls", level: "hard", q: "Stick Force per G:", options: ["Measure of Manoeuvre Stability", "Static Stability", "Speed Stability", "Drag"], ans: 0, exp: "Force to pull g.", longExp: "It defines how heavy the controls feel when pulling out of a dive or turning. Forward CG increases Stick Force per G." },
    { id: "E08", topic: "Atmosphere", level: "easy", q: "Standard Pressure at MSL:", options: ["1013.25 hPa", "1000 hPa", "1025 hPa", "760 hPa"], ans: 0, exp: "29.92 inHg.", longExp: "The International Standard Atmosphere baseline pressure." },
    { id: "E09", topic: "Lift", level: "medium", q: "The Stagnation Point:", options: ["Where airflow stops ($V=0$)", "Max Velocity", "Min Pressure", "Separation"], ans: 0, exp: "Highest pressure point.", longExp: "On the leading edge, a streamline hits the wing directly and stops. Kinetic energy converts to pressure." },
    { id: "E10", topic: "Drag", level: "hard", q: "Interference Drag is reduced by:", options: ["Fairings / Fillets", "Polishing", "Vortex Generators", "Aspect Ratio"], ans: 0, exp: "Smoothing junctions.", longExp: "Fairings smooth the airflow at sharp angles (like wing-root), preventing turbulent mixing." }
];

// --- ENGINE ---
const app = {
    state: { mode: 'practice', pool: [], idx: 0, answers: [], used: JSON.parse(localStorage.getItem('ATPL_V18') || "[]") },
    init: function() { document.getElementById('dbInfo').innerText = `Chapters 1-10: ${DB.length} Questions Loaded.`; },
    setMode: function(m) {
        this.state.mode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-practice', 'active-formulas', 'active-exam'));
        document.getElementById('m-'+m).classList.add('active-'+m);
        document.body.className = 'mode-' + m;
        const btn = document.getElementById('btnStart');
        if(m === 'practice') { btn.style.backgroundColor = "var(--primary)"; }
        else if (m === 'formulas') { btn.style.backgroundColor = "var(--purple)"; }
        else { btn.style.backgroundColor = "var(--orange)"; }
        document.getElementById('diff-box').style.display = (m === 'practice') ? 'block' : 'none';
    },
    start: function() {
        const count = parseInt(document.getElementById('count-select').value);
        const diff = document.getElementById('diff-select').value;
        let candidates = DB;
        if (this.state.mode === 'formulas') candidates = DB.filter(q => q.topic === 'Formulas');
        else if (this.state.mode === 'practice') {
            let specific = DB.filter(q => q.level === diff);
            if (specific.length >= 5) candidates = specific;
        }
        candidates.sort(() => Math.random() - 0.5);
        this.state.pool = candidates.slice(0, count);
        this.state.answers = new Array(this.state.pool.length).fill(null);
        this.state.idx = 0;
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-quiz').classList.remove('hidden');
        document.getElementById('nav-bar').classList.remove('hidden');
        this.loadQ();
    },
    loadQ: function() {
        const q = this.state.pool[this.state.idx];
        const ans = this.state.answers[this.state.idx];
        document.getElementById('qCounter').innerText = `${this.state.idx + 1} / ${this.state.pool.length}`;
        document.getElementById('qTopic').innerText = q.topic;
        document.getElementById('qLevel').innerText = q.level.toUpperCase();
        document.getElementById('qText').innerHTML = q.q;
        const box = document.getElementById('options-box');
        box.innerHTML = '';
        document.getElementById('explanation').classList.remove('show');
        q.options.forEach((opt, i) => {
            const btn = document.createElement('div');
            btn.className = 'option';
            btn.innerHTML = opt;
            btn.onclick = () => this.handleAns(i, q);
            if (this.state.mode !== 'exam') {
                if (ans !== null) {
                    if (i === q.ans) btn.classList.add('correct');
                    else if (i === ans) btn.classList.add('wrong');
                }
            } else if (ans === i) btn.classList.add('selected');
            box.appendChild(btn);
        });
        if (this.state.mode !== 'exam' && ans !== null) {
            document.getElementById('short-exp').innerHTML = `<strong>Quick Answer:</strong> ${q.exp}`;
            document.getElementById('explanation').classList.add('show');
        }
        const btnA = document.getElementById('btnAction');
        btnA.innerText = (this.state.idx === this.state.pool.length - 1) ? (this.state.mode === 'exam' ? "Submit" : "Finish") : "Next";
        if(this.state.mode === 'exam' && this.state.idx === this.state.pool.length - 1) btnA.style.backgroundColor = "var(--orange)";
    },
    handleAns: function(i, q) {
        if (this.state.mode !== 'exam' && this.state.answers[this.state.idx] !== null) return;
        this.state.answers[this.state.idx] = i;
        this.loadQ();
    },
    showDeepDive: function() {
        const q = this.state.pool[this.state.idx];
        document.getElementById('long-exp').innerHTML = q.longExp || "No detailed explanation available for this question.";
        document.getElementById('deepModal').classList.add('open');
    },
    closeDeepDive: function(e) { if (!e || e.target === e.currentTarget || e.target.tagName === 'BUTTON') document.getElementById('deepModal').classList.remove('open'); },
    next: function() { if (this.state.idx < this.state.pool.length - 1) { this.state.idx++; this.loadQ(); } else this.finish(); },
    prev: function() { if (this.state.idx > 0) { this.state.idx--; this.loadQ(); } },
    finish: function() {
        if(this.state.mode === 'exam' && !confirm("Submit?")) return;
        let c = 0; this.state.answers.forEach((a, i) => { if (a === this.state.pool[i].ans) c++; });
        const pct = Math.round((c / this.state.pool.length) * 100);
        document.getElementById('view-quiz').classList.add('hidden');
        document.getElementById('nav-bar').classList.add('hidden');
        document.getElementById('view-result').classList.remove('hidden');
        document.getElementById('scoreVal').innerText = pct + "%";
        document.getElementById('scoreMsg').innerText = pct >= 75 ? "PASSED" : "FAILED";
    },
    resetData: function() { if(confirm("Reset History?")) { localStorage.removeItem('ATPL_V18'); location.reload(); } },
    abort: function() { if(confirm("Exit?")) location.reload(); }
};
app.init();
</script>
</body>
</html>
