<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ATPL MASTER v22</title>
<style>
/* --- THEME v20 (RESTORED) --- */
:root{--primary:#007aff;--orange:#ff9f0a;--purple:#af52de;--bg:#f2f2f7;--card:#ffffff;--text:#000;--sub:#6c6c70;--border:#c6c6c8;--ok:#34c759;--no:#ff3b30;--shadow:0 4px 20px rgba(0,0,0,0.1)}
@media(prefers-color-scheme:dark){:root{--primary:#0a84ff;--bg:#000;--card:#1c1c1e;--text:#fff;--sub:#aeaeb2;--border:#38383a}}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
body{margin:0;background:var(--bg);color:var(--text);height:100dvh;display:flex;flex-direction:column;overflow:hidden}
header{height:50px;background:var(--card);border-bottom:0.5px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;font-weight:700;font-size:17px;padding-top:env(safe-area-inset-top);height:calc(50px + env(safe-area-inset-top));z-index:10}
.content{flex:1;overflow-y:auto;padding:20px 20px 150px 20px;-webkit-overflow-scrolling:touch}
.card{background:var(--card);border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.03)}
.mode-row{display:flex;gap:10px;margin-bottom:15px}
.mode-btn{flex:1;padding:15px;border-radius:12px;background:var(--card);border:2px solid transparent;text-align:center;font-weight:600;font-size:15px;box-shadow:0 2px 5px rgba(0,0,0,0.05);transition:0.2s;cursor:pointer}
.mode-btn.active-practice{border-color:var(--primary);background:rgba(0,122,255,0.1);color:var(--primary)}
.mode-btn.active-formulas{border-color:var(--purple);background:rgba(175,82,222,0.1);color:var(--purple)}
.mode-btn.active-exam{border-color:var(--orange);background:rgba(255,159,10,0.1);color:var(--orange)}
select{width:100%;padding:12px;border-radius:10px;background:var(--bg);color:var(--text);border:1px solid var(--border);margin-bottom:20px;font-size:16px}
.btn-start{width:100%;padding:16px;border-radius:14px;border:none;font-size:17px;font-weight:700;color:#fff;background:var(--primary);cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.2)}
.q-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--sub);margin-bottom:10px;font-weight:600;text-transform:uppercase}
.q-text{font-size:18px;line-height:1.4;margin-bottom:25px;font-weight:600}
.option{width:100%;padding:18px;margin-bottom:12px;background:var(--bg);border:2px solid transparent;border-radius:14px;font-size:16px;color:var(--text);cursor:pointer;position:relative}
.option.correct{background:rgba(52,199,89,0.15);border-color:var(--ok)}
.option.wrong{background:rgba(255,59,48,0.15);border-color:var(--no)}
.option.selected{background:rgba(0,122,255,0.15);border-color:var(--primary)}
body.mode-formulas .option.selected{border-color:var(--purple);background:rgba(175,82,222,0.15)}
body.mode-exam .option.selected{border-color:var(--orange);background:rgba(255,159,10,0.15)}
.explanation{margin-top:20px;padding:15px;background:rgba(255,204,0,0.15);border-radius:12px;font-size:15px;line-height:1.4;border-left:4px solid #ffcc00;display:none}
.explanation.show{display:block}
.btn-deep{background:transparent;border:1px solid var(--text);color:var(--text);padding:8px 15px;border-radius:20px;font-size:13px;font-weight:600;margin-top:10px;cursor:pointer}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(5px);z-index:2000;display:none;align-items:flex-end}
.modal.open{display:flex;animation:up 0.3s ease-out}
.modal-card{background:var(--card);width:100%;max-height:85vh;border-radius:20px 20px 0 0;padding:25px;overflow-y:auto}
.nav{position:fixed;bottom:80px;left:20px;right:20px;height:60px;background:rgba(255,255,255,0.9);backdrop-filter:blur(20px);border-radius:30px;display:flex;align-items:center;padding:5px;box-shadow:var(--shadow);z-index:999;border:1px solid rgba(255,255,255,0.2)}
@media(prefers-color-scheme:dark){.nav{background:rgba(40,40,40,0.85)}}
.nav-btn{width:50px;height:50px;border-radius:25px;border:none;background:0 0;color:var(--text);font-size:20px;font-weight:700;cursor:pointer}
.nav-btn.primary{background:var(--primary);color:#fff;width:auto;flex:1;margin:0 5px;font-size:17px}
.hidden{display:none!important}
@keyframes up{from{transform:translateY(100%)}to{transform:translateY(0)}}
</style>
</head>
<body>
<header><div>ATPL <span style="color:var(--primary)">MASTER</span></div><div id="cnt" style="font-size:14px;color:var(--sub)">Ready</div></header>
<div id="view-home" class="content">
<div class="card">
<h2 style="margin-top:0">Training Setup</h2>
<div style="font-size:13px;color:var(--sub);margin-bottom:20px" id="dbInfo">Loading...</div>
<div class="mode-row"><div class="mode-btn active-practice" id="m-practice" onclick="app.setM('practice')">üéì Practice</div><div class="mode-btn" id="m-formulas" onclick="app.setM('formulas')">üìê Formulas</div></div>
<div class="mode-btn" id="m-exam" onclick="app.setM('exam')" style="margin-bottom:20px">‚è±Ô∏è Exam Mode</div>
<div id="dif"><select id="diff-sel"><option value="easy">Easy</option><option value="medium" selected>Medium</option><option value="hard">Hard</option></select></div>
<select id="num-sel"><option value="10">10 Questions</option><option value="20" selected>20 Questions</option><option value="50">50 Questions</option><option value="100">100 Questions</option></select>
<button class="btn-start" id="btnStart" onclick="app.start()">START SESSION</button>
<div style="text-align:center;margin-top:20px"><a href="#" onclick="app.wipe()" style="color:var(--sub);font-size:12px">Reset Data</a></div>
</div></div>
<div id="view-quiz" class="content hidden">
<div class="card"><div class="q-meta"><span id="qTop"></span><span id="qLvl" style="color:var(--primary)"></span></div>
<div class="q-text" id="qTxt"></div><div id="opts"></div>
<div id="expl" class="explanation"><span id="sh-exp"></span><br><button class="btn-deep" onclick="app.deep()">üìñ Deep Dive</button></div></div></div>
<div id="nav" class="nav hidden"><button class="nav-btn" onclick="app.back()">‚Üê</button><button class="nav-btn primary" id="act" onclick="app.next()">Next</button><button class="nav-btn" onclick="app.quit()">‚úï</button></div>
<div class="modal" id="mod" onclick="app.close(event)"><div class="modal-card"><h2 style="color:var(--primary)">Deep Dive</h2><div id="dp-txt" style="line-height:1.6"></div><button class="btn-start" style="margin-top:20px" onclick="app.close(null)">Close</button></div></div>
<div id="view-res" class="content hidden" style="text-align:center"><div class="card"><h2>Results</h2><div style="font-size:50px;font-weight:800;margin:30px 0;color:var(--primary)" id="score"></div><button class="btn-start" onclick="location.reload()">Home</button></div></div>
<script>
const DB = [
    // --- ATMOSPHERE & BASICS ---
    { id: "A01", topic: "Atmosphere", level: "medium", q: "In the International Standard Atmosphere (ISA), the temperature lapse rate in the troposphere is:", options: ["1.98¬∞C per 1,000 ft (0.65¬∞C per 100 m).", "3.00¬∞C per 1,000 ft.", "Zero (Isothermal).", "2¬∞C per 1,000 ft up to 50,000 ft."], ans: 0, exp: "Standard Lapse Rate.", longExp: "The ISA assumes a linear reduction of 1.98¬∞C (approx 2¬∞C) per 1000 ft until the Tropopause at 11 km." },
    { id: "A02", topic: "Atmosphere", level: "hard", q: "Flying from High Pressure to Low Pressure at constant Indicated Altitude without adjusting the subscale:", options: ["True Altitude decreases.", "True Altitude increases.", "Remains constant.", "Indicated Altitude increases."], ans: 0, exp: "High to Low, look out below.", longExp: "The altimeter maintains a constant pressure level. Since the outside pressure is lower, that pressure level is physically closer to the ground." },
    { id: "A03", topic: "Atmosphere", level: "hard", q: "Which conditions produce the highest Density Altitude?", options: ["High Temp, Low Pressure, High Humidity.", "Low Temp, High Pressure, Dry Air.", "Standard Day.", "Cold and Dry."], ans: 0, exp: "Worst performance.", longExp: "Heat expands air, Low pressure de-compresses it, and Humidity (water vapor) is lighter than dry air. All three reduce density." },
    { id: "A04", topic: "Atmosphere", level: "medium", q: "QNH setting gives:", options: ["Altitude Above Mean Sea Level.", "Height above airfield.", "Pressure Altitude.", "Density Altitude."], ans: 0, exp: "Nautical Height.", longExp: "QNH is the station pressure reduced to MSL using ISA temperature laws. It reads altitude." },
    { id: "A05", topic: "Basic Aero", level: "medium", q: "Bernoulli's Principle in a venturi tube:", options: ["Velocity increases, Static Pressure decreases.", "Velocity decreases, Pressure increases.", "Both increase.", "Total Pressure increases."], ans: 0, exp: "Conservation of Energy.", longExp: "To maintain mass flow, air speeds up in the constriction. Dynamic pressure rises, so Static pressure must fall." },
    { id: "A06", topic: "Basic Aero", level: "hard", q: "Stagnation Point characteristics:", options: ["Velocity = 0, Static Pressure = Max.", "Velocity = Max, Pressure = Min.", "Separation point.", "Turbulent flow."], ans: 0, exp: "Impact point.", longExp: "Where the airflow hits the leading edge dead-on and stops. All Dynamic pressure converts to Static pressure." },
    { id: "A07", topic: "Basic Aero", level: "medium", q: "TAS vs IAS climbing at constant IAS:", options: ["TAS increases.", "TAS decreases.", "TAS remains constant.", "TAS equals Groundspeed."], ans: 0, exp: "Density drops.", longExp: "As density decreases with altitude, you must fly faster through the air (TAS) to get the same pressure reading (IAS)." },
    
    // --- LIFT ---
    { id: "L01", topic: "Lift", level: "medium", q: "Centre of Pressure movement on cambered wing (AoA increasing):", options: ["Moves forward.", "Moves aft.", "Stationary.", "Moves to tip."], ans: 0, exp: "Suction peak forward.", longExp: "As AoA increases, the lowest pressure point shifts to the leading edge. The CP follows this." },
    { id: "L02", topic: "Lift", level: "hard", q: "Aerodynamic Centre (AC) is defined as:", options: ["Point where Pitching Moment is constant.", "Point where Lift acts.", "Point of max thickness.", "CG location."], ans: 0, exp: "Stability anchor.", longExp: "The AC (approx 25% chord) is where the pitching moment coefficient does not change with AoA." },
    { id: "L03", topic: "Lift", level: "medium", q: "Geometric Washout (Twist) ensures:", options: ["Root stalls before Tip.", "Tip stalls before Root.", "Increased Lift.", "Less Drag."], ans: 0, exp: "Aileron control.", longExp: "The tip has a lower angle of incidence, so it keeps flying when the root has stalled." },
    { id: "L04", topic: "Lift", level: "hard", q: "Ground Effect causes:", options: ["Decreased Induced Drag, Increased Effective AoA.", "Increased Drag.", "Decreased Lift.", "Turbulence."], ans: 0, exp: "Vortex blocking.", longExp: "Proximity to ground stops vortices forming, reducing downwash and drag. This causes 'floating'." },
    { id: "L05", topic: "Lift", level: "medium", q: "Symmetrical Airfoil at 0¬∞ AoA:", options: ["Produces 0 Lift.", "Positive Lift.", "Negative Lift.", "Max Drag."], ans: 0, exp: "No camber.", longExp: "Identical pressure on top and bottom means no net vertical force." },
    
    // --- DRAG ---
    { id: "D01", topic: "Drag", level: "medium", q: "Induced Drag varies with speed as:", options: ["1 / V¬≤.", "V¬≤.", "Linear.", "Constant."], ans: 0, exp: "Inverse square.", longExp: "Slow speed = High AoA = Strong Vortices = High Induced Drag." },
    { id: "D02", topic: "Drag", level: "medium", q: "Parasite Drag varies with speed as:", options: ["V¬≤.", "1 / V¬≤.", "Linear.", "Constant."], ans: 0, exp: "Square.", longExp: "Air resistance increases exponentially with speed." },
    { id: "D03", topic: "Drag", level: "hard", q: "Minimum Drag Speed (Vmd) is where:", options: ["Induced Drag = Parasite Drag.", "Parasite Drag is zero.", "Lift is Max.", "Stall occurs."], ans: 0, exp: "Crossover point.", longExp: "The bottom of the drag bucket is where the two drag curves intersect." },
    { id: "D04", topic: "Drag", level: "medium", q: "Interference Drag is reduced by:", options: ["Fairings (Fillets).", "Polishing.", "Vortex Generators.", "Winglets."], ans: 0, exp: "Smooth junctions.", longExp: "Fairings smooth the airflow at sharp angles (e.g., wing root) to prevent mixing eddies." },
    { id: "D05", topic: "Drag", level: "hard", q: "Speed Stability below Vmd:", options: ["Unstable (Speed unstable).", "Stable.", "Neutral.", "Improving."], ans: 0, exp: "Back of the drag curve.", longExp: "If you slow down below Vmd, drag *increases*, causing you to slow further. You must add power." },
    { id: "D06", topic: "Drag", level: "medium", q: "Form Drag is highest on:", options: ["Flat plate perpendicular to flow.", "Sphere.", "Airfoil.", "Teardrop."], ans: 0, exp: "Separation.", longExp: "A flat plate causes immediate separation and a huge low-pressure wake." },
    
    // --- STALLING ---
    { id: "S01", topic: "Stalling", level: "medium", q: "Stall depends ONLY on:", options: ["Angle of Attack.", "Airspeed.", "Weight.", "Attitude."], ans: 0, exp: "Critical Alpha.", longExp: "Stall happens whenever Critical AoA is exceeded, regardless of speed (e.g., high speed stall)." },
    { id: "S02", topic: "Stalling", level: "hard", q: "Stall speed in a 60¬∞ bank turn:", options: ["Increases by 41%.", "Doubles.", "Increases by 10%.", "Unchanged."], ans: 0, exp: "Load Factor root.", longExp: "Load Factor is 2g. Vs increases by sqrt(2) = 1.41." },
    { id: "S03", topic: "Stalling", level: "medium", q: "Forward CG effect on Stall Speed:", options: ["Increases Vs.", "Decreases Vs.", "No effect.", "Prevents stall."], ans: 0, exp: "Tail load.", longExp: "Forward CG requires tail downforce. Wings must lift Weight + Tail force, reaching critical AoA sooner." },
    { id: "S04", topic: "Stalling", level: "medium", q: "Stall warning margin:", options: ["5-10 kts / 5-10% prior to stall.", "At stall.", "After stall.", "20 kts prior."], ans: 0, exp: "Safety.", longExp: "Must alert the pilot with enough time to react (Buffet, Horn, Stick Shaker)." },
    { id: "S05", topic: "Stalling", level: "hard", q: "Deep Stall (Super Stall) risk:", options: ["T-tail aircraft.", "Low wing.", "Canard.", "Delta."], ans: 0, exp: "Blanketed tail.", longExp: "Wake from stalled main wing covers the high tail, rendering elevators ineffective." },
    { id: "S06", topic: "Stalling", level: "hard", q: "Spin is defined as:", options: ["Aggravated stall with autorotation.", "Spiral dive.", "Steep turn.", "Roll."], ans: 0, exp: "Stall + Yaw.", longExp: "One wing is more stalled than the other. Drag difference drives rotation." },
    { id: "S07", topic: "Stalling", level: "hard", q: "Standard Spin Recovery:", options: ["Power Idle, Ailerons Neutral, Rudder Opposite, Stick Fwd.", "Power Max, Stick Back.", "Ailerons into spin.", "Wait."], ans: 0, exp: "PARE.", longExp: "Remove torque (Idle), Remove drag (Neutral), Stop Yaw (Rudder), Unstall (Stick Fwd)." },
    
    // --- HIGH LIFT ---
    { id: "H01", topic: "High Lift", level: "medium", q: "Flaps primarily increase:", options: ["Camber and CLmax.", "Speed.", "Stability.", "Aspect Ratio."], ans: 0, exp: "Curvature.", longExp: "Increasing camber shifts the lift curve up, allowing higher lift at slower speeds." },
    { id: "H02", topic: "High Lift", level: "hard", q: "Slats function:", options: ["Re-energize boundary layer via slot.", "Increase camber.", "Increase area.", "Drag."], ans: 0, exp: "Delay separation.", longExp: "High pressure air from below accelerates through the slot, keeping airflow attached to higher AoA." },
    { id: "H03", topic: "High Lift", level: "medium", q: "Fowler Flaps:", options: ["Move back and down (Area + Camber).", "Down only.", "LE device.", "Split."], ans: 0, exp: "Most efficient.", longExp: "Increase wing area (slide back) and camber (rotate down). Highest CL increase." },
    { id: "H04", topic: "High Lift", level: "hard", q: "Flap effect on Trim (High Wing):", options: ["Pitch Up (Downwash on tail).", "Pitch Down.", "No change.", "Roll."], ans: 0, exp: "Tail load.", longExp: "Increased downwash pushes the tail down, pitching the nose up (e.g., C172)." },
    
    // --- STABILITY ---
    { id: "ST01", topic: "Stability", level: "medium", q: "Static Stability:", options: ["Initial tendency to return.", "Oscillation.", "Control force.", "Time to return."], ans: 0, exp: "Immediate reaction.", longExp: "If disturbed, does the aircraft try to come back? (Positive Static Stability)." },
    { id: "ST02", topic: "Stability", level: "medium", q: "Longitudinal Stability depends on:", options: ["CG position vs Neutral Point.", "Wing span.", "Rudder.", "Ailerons."], ans: 0, exp: "Pitch balance.", longExp: "CG must be forward of the Neutral Point (Aerodynamic Center of the whole aircraft)." },
    { id: "ST03", topic: "Stability", level: "hard", q: "Aft CG effect on Stability:", options: ["Reduces stability.", "Increases stability.", "No effect.", "Increases stall speed."], ans: 0, exp: "Short lever arm.", longExp: "Closer to Neutral Point = Less restoring moment. Aircraft becomes twitchy." },
    { id: "ST04", topic: "Stability", level: "hard", q: "Dutch Roll cause:", options: ["Lateral Stability > Directional Stability.", "Directional > Lateral.", "Forward CG.", "Stall."], ans: 0, exp: "Wallow.", longExp: "Too much dihedral effect causes roll/yaw oscillation." },
    { id: "ST05", topic: "Stability", level: "medium", q: "Dihedral effect:", options: ["Rolls wings level during sideslip.", "Prevents stall.", "Increases speed.", "Yaw stability."], ans: 0, exp: "Lateral stability.", longExp: "In a slip, the lower wing has higher effective AoA, rolling the aircraft level." },
    { id: "ST06", topic: "Stability", level: "medium", q: "Stick Force per G:", options: ["Manoeuvre Stability.", "Static Stability.", "Speed Stability.", "Drag."], ans: 0, exp: "Tactile feedback.", longExp: "Prevents pilot from overstressing the airframe by making controls heavy under load." },
    // --- CONTROLS ---
    { id: "C01", topic: "Controls", level: "medium", q: "Adverse Yaw is caused by:", options: ["Induced Drag on the up-going wing.", "Parasite drag.", "Rudder.", "Prop torque."], ans: 0, exp: "Lift penalty.", longExp: "The wing rising (outside of turn) creates more lift and thus more drag, pulling the nose outwards." },
    { id: "C02", topic: "Controls", level: "hard", q: "Frise Ailerons:", options: ["Project leading edge into airflow to create drag.", "Move differentially.", "Mass balance.", "Trim."], ans: 0, exp: "Counter adverse yaw.", longExp: "The up-going aileron's nose sticks out to create parasite drag on the inside wing." },
    { id: "C03", topic: "Controls", level: "medium", q: "Differential Ailerons:", options: ["Up moves more than Down.", "Down moves more.", "Equal.", "None."], ans: 0, exp: "Drag balance.", longExp: "Minimizes drag increase on the down-going (outside) aileron." },
    { id: "C04", topic: "Controls", level: "hard", q: "Mass Balance weights:", options: ["Prevent Flutter.", "Trim.", "Reduce stick force.", "Increase stability."], ans: 0, exp: "Inertial coupling.", longExp: "Moves CG of the surface to the hinge line to stop aeroelastic oscillation." },
    { id: "C05", topic: "Controls", level: "hard", q: "Aerodynamic Balance (Horn):", options: ["Area forward of hinge assists movement.", "Weight.", "Trim.", "Tab."], ans: 0, exp: "Pressure assist.", longExp: "Air pressure on the horn helps the pilot move the control surface." },
    { id: "C06", topic: "Controls", level: "medium", q: "Balance Tab:", options: ["Moves opposite to surface.", "Moves same way.", "Fixed.", "Trim."], ans: 0, exp: "Reduces force.", longExp: "Airflow on tab helps push the main surface." },
    { id: "C07", topic: "Controls", level: "medium", q: "Anti-Balance Tab:", options: ["Moves same way as surface.", "Opposite.", "Fixed.", "Trim."], ans: 0, exp: "Increases force.", longExp: "Used on stabilators to give 'feel' (heaviness) to the pilot." },
    { id: "C08", topic: "Controls", level: "medium", q: "Servo Tab:", options: ["Pilot moves tab, tab moves surface.", "Pilot moves surface.", "Trim.", "Lock."], ans: 0, exp: "No direct link.", longExp: "Used on large aircraft where manual force is insufficient." },
    
    // --- OPERATIONAL SCENARIOS ---
    { id: "OPS_01", topic: "Ops Hazards", level: "hard", q: "Wing Icing effect:", options: ["Unpredictable stall speed increase.", "Weight only.", "Drag only.", "None."], ans: 0, exp: "Shape change.", longExp: "Ice roughness disrupts boundary layer, causing early separation." },
    { id: "OPS_02", topic: "Ops Hazards", level: "hard", q: "Tailplane Icing:", options: ["Violent Nose Down pitch (Tail stall).", "Nose Up.", "No effect.", "Roll."], ans: 0, exp: "Loss of downforce.", longExp: "If tail stalls, the balancing downforce is lost, and the nose drops." },
    { id: "OPS_03", topic: "Ops Wake", level: "medium", q: "Wake Turbulence strongest from:", options: ["Heavy, Clean, Slow.", "Light, Fast.", "Dirty, Fast.", "Small."], ans: 0, exp: "High Lift.", longExp: "Heavy (High Lift), Clean (High Alpha), Slow (High Alpha)." },
    { id: "OPS_04", topic: "Ops Wake", level: "medium", q: "Avoidance on landing behind Heavy:", options: ["Stay above path, land beyond touchdown.", "Land short.", "Fly below.", "Side-step."], ans: 0, exp: "Avoid sink.", longExp: "Vortices sink. Stay high and land long." },
    { id: "OPS_05", topic: "Ops Aero", level: "hard", q: "Tailwind Takeoff:", options: ["Longer ground run required.", "Shorter.", "Same.", "Better climb."], ans: 0, exp: "Groundspeed.", longExp: "Must accelerate to higher groundspeed to achieve liftoff airspeed." },
    { id: "OPS_06", topic: "Ops Aero", level: "medium", q: "Hydroplaning speed (kts):", options: ["9 * sqrt(PSI).", "Vref.", "V1.", "7 * PSI."], ans: 0, exp: "Tire pressure.", longExp: "Speed at which tire loses contact with runway." },
    { id: "OPS_07", topic: "Ops Limits", level: "hard", q: "Va (Manoeuvring Speed) with lower weight:", options: ["Decreases.", "Increases.", "Constant.", "None."], ans: 0, exp: "F=ma.", longExp: "Lighter aircraft accelerates faster into G-load. Must fly slower to stall before breaking." },
    { id: "OPS_08", topic: "Ops Limits", level: "medium", q: "Vne:", options: ["Never Exceed Speed.", "Normal.", "Cruise.", "Stall."], ans: 0, exp: "Red line.", longExp: "Structural damage or flutter beyond this speed." },
    { id: "OPS_09", topic: "Ops Windshear", level: "hard", q: "Microburst encounter:", options: ["Headwind -> Downdraft -> Tailwind.", "Tailwind -> Updraft.", "Constant wind.", "Calm."], ans: 0, exp: "Lift trap.", longExp: "Performance increases then collapses." },
    { id: "OPS_10", topic: "Ops Prop", level: "medium", q: "P-Factor (Asymmetric Blade Effect):", options: ["Yaw to left (high power/high AoA).", "Roll.", "Pitch.", "Drag."], ans: 0, exp: "Descending blade.", longExp: "Descending blade has higher AoA and thrust." },
    
    // --- FORMULAS (MATH) ---
    { id: "F01", topic: "Formulas", level: "medium", q: "Load Factor (n):", options: ["1 / cos(phi)", "sin(phi)", "tan(phi)", "cos(phi)"], ans: 0, exp: "Bank angle.", longExp: "n = Lift/Weight. In a turn, L = W/cos(bank)." },
    { id: "F02", topic: "Formulas", level: "hard", q: "Vs new vs Weight:", options: ["Vs2 = Vs1 * sqrt(W2/W1)", "Linear", "Square", "None"], ans: 0, exp: "Root relationship.", longExp: "Stall speed varies with the square root of the weight change." },
    { id: "F03", topic: "Formulas", level: "hard", q: "Turn Radius:", options: ["V^2 / (g tan phi)", "V / tan phi", "V g", "V^2"], ans: 0, exp: "V squared.", longExp: "Radius increases rapidly with speed and decreases with bank angle." },
    { id: "F04", topic: "Formulas", level: "hard", q: "Rate of Turn:", options: ["g tan phi / V", "V / R", "V tan phi", "Const"], ans: 0, exp: "Inverse V.", longExp: "For a fixed bank, faster speed means slower rate of turn." },
    { id: "F05", topic: "Formulas", level: "medium", q: "Dynamic Pressure (q):", options: ["1/2 rho V^2", "rho V", "Pt", "V^2"], ans: 0, exp: "Kinetic.", longExp: "Energy of the air motion per unit volume." },
    { id: "F06", topic: "Formulas", level: "medium", q: "Lift Coefficient:", options: ["L / (q S)", "L q S", "D/L", "q/S"], ans: 0, exp: "Rearranged lift formula.", longExp: "CL is the dimensionless lift capability of the wing." },
    { id: "F07", topic: "Formulas", level: "hard", q: "Glide Ratio:", options: ["Lift / Drag", "Thrust / Drag", "Weight / Lift", "Speed / Fuel"], ans: 0, exp: "Efficiency.", longExp: "Distance traveled per unit height lost." },
    { id: "F08", topic: "Formulas", level: "medium", q: "Power:", options: ["Force x Velocity", "Force x Time", "Mass x Accel", "Energy"], ans: 0, exp: "Rate of work.", longExp: "Power is work done over time, or Force times Velocity." },
    { id: "F09", topic: "Formulas", level: "hard", q: "Climb Gradient:", options: ["(T-D)/W", "L/W", "T/W", "D/L"], ans: 0, exp: "Excess Thrust.", longExp: "The angle of climb depends on Excess Thrust vs Weight." },
    { id: "F10", topic: "Formulas", level: "hard", q: "Specific Range:", options: ["TAS / Fuel Flow", "GS / Fuel", "Power", "Drag"], ans: 0, exp: "Economy.", longExp: "Distance per unit fuel." },
    { id: "F11", topic: "Formulas", level: "medium", q: "Pressure (P):", options: ["Force / Area", "Mass / Vol", "Force x Dist", "Energy"], ans: 0, exp: "Pascal.", longExp: "Force applied distributed over an area." },
    { id: "F12", topic: "Formulas", level: "easy", q: "Density (rho):", options: ["Mass / Volume", "Force / Area", "Weight", "Pressure"], ans: 0, exp: "kg/m3.", longExp: "How tightly packed the matter is." },
    { id: "F13", topic: "Formulas", level: "hard", q: "Mach Number:", options: ["TAS / LSS", "IAS / LSS", "TAS / GS", "LSS / TAS"], ans: 0, exp: "Speed of Sound.", longExp: "Ratio of True Airspeed to Local Speed of Sound." },
    { id: "F14", topic: "Formulas", level: "hard", q: "Local Speed of Sound (a):", options: ["38.94 * sqrt(T)", "sqrt(P)", "TAS", "Constant"], ans: 0, exp: "Kelvin.", longExp: "Depends only on the square root of Temperature (Kelvin)." },
    { id: "F15", topic: "Formulas", level: "medium", q: "Aspect Ratio:", options: ["Span^2 / Area", "Chord", "Thick", "Area"], ans: 0, exp: "Slenderness.", longExp: "Geometric efficiency." },
    { id: "F16", topic: "Formulas", level: "medium", q: "Moment:", options: ["Force x Arm", "Mass x V", "Power", "Work"], ans: 0, exp: "Turning.", longExp: "Torque." },
    { id: "F17", topic: "Formulas", level: "hard", q: "Hydroplaning Speed (kts):", options: ["9 * sqrt(PSI)", "7 * PSI", "Vref", "V1"], ans: 0, exp: "Tire Pressure.", longExp: "Rotating tire formula." },
    { id: "F18", topic: "Formulas", level: "hard", q: "Turn Diameter:", options: ["2 * Radius", "Radius", "V^2", "g"], ans: 0, exp: "Geometry.", longExp: "Simply double the radius." },// --- PACCHETTO 3: ADVANCED STABILITY & CONTROL (The "EASA Killers") ---
    
    // --- STABILITY (Advanced) ---
    { id: "ST_ADV_01", topic: "Stability", level: "hard", q: "The difference between Stick Fixed and Stick Free longitudinal stability is determined by:", options: ["The aerodynamic balance of the elevator (floating tendency).", "The friction in the control circuit.", "The size of the tailplane.", "The position of the CG."], ans: 0, exp: "Floating controls.", longExp: "If the pilot lets go of the stick (Free), the elevator may float with the airflow. If it floats 'against' the restoring force, Stick Free stability is lower than Stick Fixed (held rigid)." },
    { id: "ST_ADV_02", topic: "Stability", level: "hard", q: "A high wing aircraft generally requires less dihedral than a low wing aircraft because:", options: ["The Centre of Gravity is below the Centre of Pressure, creating a pendulum (Keel) effect.", "The high wing produces more lift.", "The high wing is less affected by ground effect.", "The fuselage interferes with the airflow."], ans: 0, exp: "Pendulum stability.", longExp: "In a sideslip, the weight of the fuselage acts like a pendulum under the high wing, naturally rolling the aircraft back to level. This provides lateral stability without needing much geometric dihedral." },
    { id: "ST_ADV_03", topic: "Stability", level: "medium", q: "Which of the following creates a nose-down pitching moment?", options: ["The Centre of Pressure moving rearwards.", "Extending landing gear (if drag line is below CG).", "Increasing thrust (if thrust line is below CG).", "Moving the CG rearwards."], ans: 0, exp: "Lever arm increases.", longExp: "Lift acts upwards at the CP. Weight acts downwards at the CG. If the CP moves further aft (away from CG), the lever arm increases, causing the nose to pitch down (typical in Mach Tuck)." },
    { id: "ST_ADV_04", topic: "Stability", level: "hard", q: "The 'Static Margin' is defined as:", options: ["The distance between the Centre of Gravity and the Neutral Point.", "The distance between the CG and the Centre of Pressure.", "The range of movement of the elevator.", "The difference between Stick Fixed and Stick Free stability."], ans: 0, exp: "Stability buffer.", longExp: "The Static Margin quantifies how stable the aircraft is. A larger margin (CG further forward of Neutral Point) means a very stable, but 'heavy' handling aircraft." },
    { id: "ST_ADV_05", topic: "Stability", level: "medium", q: "Spiral Instability (Spiral Dive) occurs when:", options: ["Directional Stability is very strong compared to Lateral Stability.", "Lateral Stability is very strong.", "The CG is too far aft.", "The aircraft enters a spin."], ans: 0, exp: "Too much yaw stability.", longExp: "If the fin is too big (Directional) and dihedral too weak (Lateral), the aircraft corrects yaw instantly but fails to roll wings level. The bank angle increases, the nose drops, and speed builds up rapidly." },

    // --- CONTROLS (Advanced Tabs) ---
    { id: "CTL_ADV_01", topic: "Controls", level: "hard", q: "A Spring Tab is designed to:", options: ["Provide aerodynamic assistance only at high speeds.", "Provide assistance at all speeds.", "Increase stick force at high speeds.", "Trim the aircraft."], ans: 0, exp: "Speed sensitive.", longExp: "At low speeds, the spring is rigid and the pilot moves the surface directly. At high speeds, air resistance compresses the spring, and the tab moves to assist the pilot." },
    { id: "CTL_ADV_02", topic: "Controls", level: "hard", q: "What is the purpose of an Internal Balance (Sealed Aileron)?", options: ["To reduce the force required to move the aileron.", "To prevent air leaking from high to low pressure sides.", "To increase drag.", "To mass balance the surface."], ans: 0, exp: "Pressure assist.", longExp: "A 'beak' forward of the hinge line moves inside a chamber. Pressure differences across the wing assist the movement of the beak, reducing the stick force needed." },
    { id: "CTL_ADV_03", topic: "Controls", level: "medium", q: "On a Servo-Tab operated control surface:", options: ["The pilot moves the tab, and the tab moves the main surface.", "The pilot moves the main surface, and the tab moves opposite.", "The tab is for trimming only.", "The tab prevents flutter."], ans: 0, exp: "Indirect control.", longExp: "Used on large manual aircraft. The pilot's controls are connected ONLY to the tab. The aerodynamic force on the tab pushes the huge main surface." },
    
    // --- STALLING (Wing Shapes) ---
    { id: "STL_ADV_01", topic: "Stalling", level: "hard", q: "The stalling pattern of a rectangular wing (Planform taper = 1) is typically:", options: ["Starting at the root.", "Starting at the tip.", "Starting at the trailing edge uniformly.", "Instantaneous across the span."], ans: 0, exp: "Desirable.", longExp: "Rectangular wings are safe because the root stalls first. This causes a buffet (warning) on the tail and keeps the ailerons (at the tips) working to control roll." },
    { id: "STL_ADV_02", topic: "Stalling", level: "hard", q: "The stalling pattern of a highly tapered or swept wing is typically:", options: ["Starting at the tip.", "Starting at the root.", "Uniform.", "Safe."], ans: 0, exp: "Dangerous.", longExp: "Tapered/Swept wings tend to stall at the tips first. This causes a loss of aileron control (roll instability) and, on swept wings, a 'Pitch Up' moment (instability)." },
    { id: "STL_ADV_03", topic: "Stalling", level: "medium", q: "Vortex Generators on the upper wing surface:", options: ["Energize the boundary layer to delay separation.", "Increase induced drag.", "Reduce parasite drag.", "Prevent shockwaves."], ans: 0, exp: "Mixing air.", longExp: "They create tiny vortices that pull high-energy air from outside the boundary layer down to the skin. This energized air can stick to the wing longer, delaying the stall." },

    // --- PROPELLER AERODYNAMICS (Ch 9/10 Context) ---
    { id: "PROP_01", topic: "Basic Aero", level: "hard", q: "Gyroscopic Precession on a propeller aircraft means that if you pitch the nose UP:", options: ["A yawing force is created 90 degrees later in the direction of rotation.", "The aircraft rolls.", "Torque increases.", "P-factor decreases."], ans: 0, exp: "Rigidity.", longExp: "A force applied to the rim of a gyro (the prop) acts 90¬∞ later in the direction of rotation. Pitching up applies a force at the 'top/bottom'. This results in a Yaw force (Right Yaw for CW prop)." },
    { id: "PROP_02", topic: "Basic Aero", level: "medium", q: "Torque effect (Newtons 3rd Law) causes:", options: ["Roll opposite to propeller rotation.", "Yaw opposite to rotation.", "Pitch up.", "Drag."], ans: 0, exp: "Reaction.", longExp: "The engine twists the prop clockwise (from cockpit). The equal and opposite reaction twists the whole aircraft counter-clockwise (Roll Left)." },
    { id: "PROP_03", topic: "Basic Aero", level: "medium", q: "Slipstream effect (Spiralling airflow) primarily acts on:", options: ["The vertical fin, causing yaw.", "The wings, causing roll.", "The elevator, causing pitch.", "The ailerons."], ans: 0, exp: "Corkscrew.", longExp: "The air from the prop spirals around the fuselage and hits the vertical fin on the left side (for a CW prop), pushing the tail right and the nose LEFT." },

    // --- FINAL TRICKY ONES ---
    { id: "TRICK_01", topic: "Lift", level: "hard", q: "If the Indicated Airspeed is kept constant while climbing:", options: ["Lift remains constant (ignoring compressibility).", "Lift decreases.", "Lift increases.", "Drag decreases."], ans: 0, exp: "Dynamic pressure const.", longExp: "Lift depends on Dynamic Pressure ($1/2 rho V^2$). IAS is essentially a measure of Dynamic Pressure. If IAS is constant, 'q' is constant, so Lift is constant (assuming same weight/AoA)." },
    { id: "TRICK_02", topic: "Drag", level: "medium", q: "The speed for Minimum Power (endurance) is:", options: ["Lower than the speed for Minimum Drag (range).", "Higher than Vmd.", "Same as Vmd.", "Vno."], ans: 0, exp: "Vmp < Vmd.", longExp: "Power = Drag x Speed. The minimum of the Power curve occurs at a lower speed (approx 0.76 Vmd) than the minimum of the Drag curve." },
    { id: "TRICK_03", topic: "Stalling", level: "hard", q: "In a stable spin, the airspeed is:", options: ["Constant and low.", "Increasing rapidly.", "Decreasing.", "Fluctuating."], ans: 0, exp: "Equilibrium.", longExp: "A spin is a stable stalled condition. Drag equals Weight component. The speed is steady and relatively low, unlike a spiral dive where speed increases rapidly." }
];

const app={
state:{mode:'practice',pool:[],idx:0,answers:[],used:JSON.parse(localStorage.getItem('ATPL_V22')||"[]")},
init:function(){document.getElementById('dbInfo').innerText=`Loaded: ${DB.length} Questions`},
setM:function(m){
this.state.mode=m;
document.querySelectorAll('.mode-btn').forEach(b=>b.className='mode-btn');
document.getElementById('m-'+m).classList.add('active-'+m);
document.body.className='mode-'+m;
const b=document.getElementById('btnStart');
b.style.backgroundColor=m==='practice'?'var(--primary)':m==='formulas'?'var(--purple)':'var(--orange)';
document.getElementById('dif').style.display=m==='practice'?'block':'none';
},
start:function(){
const cnt=parseInt(document.getElementById('num-sel').value);
const dif=document.getElementById('diff-sel').value;
let c=DB;
if(this.state.mode==='formulas')c=DB.filter(q=>q.topic==='Formulas');
else if(this.state.mode==='practice'){let s=DB.filter(q=>q.level===dif);if(s.length>4)c=s}
c.sort(()=>Math.random()-0.5);
this.state.pool=c.slice(0,cnt);
this.state.answers=new Array(this.state.pool.length).fill(null);
this.state.idx=0;
document.getElementById('view-home').classList.add('hidden');
document.getElementById('view-quiz').classList.remove('hidden');
document.getElementById('nav').classList.remove('hidden');
this.load();
},
load:function(){
const q=this.state.pool[this.state.idx];
const a=this.state.answers[this.state.idx];
document.getElementById('cnt').innerText=`${this.state.idx+1} / ${this.state.pool.length}`;
document.getElementById('qTop').innerText=q.topic;
document.getElementById('qLvl').innerText=q.level.toUpperCase();
document.getElementById('qTxt').innerHTML=q.q;
const b=document.getElementById('opts');b.innerHTML='';
document.getElementById('expl').classList.remove('show');
q.options.forEach((o,i)=>{
const d=document.createElement('div');d.className='option';d.innerHTML=o;
d.onclick=()=>this.ans(i);
if(this.state.mode!=='exam'){
if(a!==null){if(i===q.ans)d.classList.add('correct');else if(i===a)d.classList.add('wrong')}
}else if(a===i)d.classList.add('selected');
b.appendChild(d);
});
if(this.state.mode!=='exam'&&a!==null){
document.getElementById('sh-exp').innerHTML=`<strong>Answer:</strong> ${q.exp}`;
document.getElementById('expl').classList.add('show');
}
const act=document.getElementById('act');
act.innerText=(this.state.idx===this.state.pool.length-1)?(this.state.mode==='exam'?'Submit':'Finish'):'Next';
if(this.state.mode==='exam'&&this.state.idx===this.state.pool.length-1)act.style.backgroundColor='var(--orange)';
},
ans:function(i){
if(this.state.mode!=='exam'&&this.state.answers[this.state.idx]!==null)return;
this.state.answers[this.state.idx]=i;
this.load();
},
deep:function(){
const q=this.state.pool[this.state.idx];
document.getElementById('dp-txt').innerHTML=q.longExp||"No details.";
document.getElementById('mod').classList.add('open');
},
close:function(e){if(!e||e.target===e.currentTarget||e.target.tagName==='BUTTON')document.getElementById('mod').classList.remove('open')},
next:function(){if(this.state.idx<this.state.pool.length-1){this.state.idx++;this.load()}else this.end()},
back:function(){if(this.state.idx>0){this.state.idx--;this.load()}},
end:function(){
if(this.state.mode==='exam'&&!confirm("Submit?"))return;
let c=0;this.state.answers.forEach((a,i)=>{if(a===this.state.pool[i].ans)c++});
const p=Math.round((c/this.state.pool.length)*100);
document.getElementById('view-quiz').classList.add('hidden');
document.getElementById('nav').classList.add('hidden');
document.getElementById('view-res').classList.remove('hidden');
document.getElementById('score').innerText=p+"%";
},
wipe:function(){if(confirm("Reset?")){localStorage.removeItem('ATPL_V22');location.reload()}},
quit:function(){if(confirm("Exit?"))location.reload()}
};
app.init();
</script>
</body>
</html>
